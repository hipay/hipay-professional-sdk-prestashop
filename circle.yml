machine:
  services:
    - docker
dependencies:
    pre:
      - sh ./bin/deployment/setup_sonar.sh
test:
  pre:
      - sudo apt-get install sshpass
      - ./prestashop.sh init-stage
  override:
    - sleep 500
    - curl --retry 10 --retry-delay 20 -v http://localhost:8086
    - curl --retry 10 --retry-delay 20 -v http://localhost:8087
  post:
    - sh ./bin/deployment/sonar.sh > /dev/null
deployment:
  prod:
    branch: /.*?/
    tag: /.*?/
    commands:
      - ./package-ready-for-prestashop/builder/module_builder.sh -v ${CIRCLE_BRANCH////-}
      - mkdir $CIRCLE_ARTIFACTS/package
      - cp ./package-ready-for-prestashop/*.zip $CIRCLE_ARTIFACTS/package
      - chmod u+x bin/deployment/deploy_project.sh
      - ./bin/deployment/deploy_project.sh
